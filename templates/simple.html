<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../static/css/simple.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>For Real Simple Mode</title>
  </head>
  <body>
    <div class="background-container">
      <!-- Setting Toggle Button -->
      <div class="settings-container">
        <button class="settings-button">
          <svg
            id="Settings_24"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
          >
            <g transform="matrix(0.43 0 0 0.43 12 12)">
              <path
                class="gear-set"
                transform=" translate(-25, -25)"
                d="M 47.16 21.221 L 41.25 20.255 C 40.904 19.069 40.431 17.929 39.839 16.849999999999998 L 43.289 11.932999999999998 C 43.568000000000005 11.535999999999998 43.52 10.994999999999997 43.177 10.650999999999998 L 39.288 6.763999999999998 C 38.940999999999995 6.4179999999999975 38.394999999999996 6.3729999999999976 37.997 6.6599999999999975 L 33.153999999999996 10.140999999999998 C 32.065 9.538999999999998 30.914999999999996 9.060999999999998 29.721999999999998 8.713999999999999 L 28.691 2.8279999999999985 C 28.607 2.35 28.192 2 27.706 2 L 22.206 2 C 21.716 2 21.298 2.355 21.219 2.839 L 20.263 8.693 C 19.063000000000002 9.038 17.911 9.511 16.826 10.105 L 11.996 6.655 C 11.597000000000001 6.37 11.054 6.416 10.707 6.761 L 6.82 10.648 C 6.477 10.991 6.429 11.530999999999999 6.708 11.927999999999999 L 10.107 16.791 C 9.501999999999999 17.886 9.02 19.045 8.668999999999999 20.251 L 2.8379999999999983 21.222 C 2.355999999999998 21.302 2.0019999999999984 21.720000000000002 2.0019999999999984 22.208000000000002 L 2.0019999999999984 27.708000000000002 C 2.0019999999999984 28.193 2.3499999999999983 28.608 2.826999999999998 28.693 L 8.657999999999998 29.727 C 9.006999999999998 30.93 9.488999999999997 32.089 10.095999999999998 33.187 L 6.6549999999999985 38 C 6.370999999999999 38.397 6.415999999999999 38.942 6.760999999999998 39.289 L 10.648999999999997 43.18 C 10.991999999999997 43.523 11.532999999999998 43.571 11.929999999999998 43.292 L 16.799999999999997 39.881 C 17.892999999999997 40.482 19.048 40.959 20.244999999999997 41.305 L 21.220999999999997 47.166 C 21.3 47.647 21.717 48 22.206 48 L 27.706 48 C 28.191 48 28.605999999999998 47.652 28.689999999999998 47.175 L 29.735 41.285 C 30.934 40.931999999999995 32.083 40.452 33.165 39.849999999999994 L 38.07 43.291 C 38.468 43.571999999999996 39.008 43.522999999999996 39.352000000000004 43.18 L 43.24 39.289 C 43.586 38.942 43.631 38.395 43.344 37.997 L 39.846000000000004 33.14 C 40.43900000000001 32.06 40.910000000000004 30.918 41.253 29.732 L 47.171 28.692999999999998 C 47.65 28.608999999999998 47.998 28.192999999999998 47.998 27.708 L 47.998 22.208 C 47.999 21.718 47.644 21.3 47.16 21.221 z M 25 32 C 21.134 32 18 28.866 18 25 C 18 21.134 21.134 18 25 18 C 28.866 18 32 21.134 32 25 C 32 28.866 28.866 32 25 32 z"
                stroke-linecap="round"
              />
            </g>
          </svg>
        </button>
        <div class="popup">
          <div class="toggle-container2">
            <span>Simple Mode</span>
            <label class="toggle">
              <input type="checkbox" id="simpleMode" checked />
              <span class="slider"></span>
            </label>
          </div>
          <div class="toggle-container2">
            <span>Dark Mode</span>
            <label class="toggle">
              <input type="checkbox" id="darkMode" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      <!-- Logo -->
      <div class="logoFR" onclick="location.reload()" style="display: block">
        FOR<br />REAL
      </div>
      <!-- Switch model -->
      <div class="toggle-container">
        <div class="toggle-circle"></div>
        <span class="toggle-text">Hybrid</span>
      </div>
      <div class="container-position">
        <div class="upload-container" id="upload-area" style="display: block">
          <div class="upload-icon">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"
              />
            </svg>
          </div>
          <div class="upload-text">Drag and drop audio files to upload</div>
          <div class="supported-files">Supported Files: .wav, .flac, .mp3</div>
          <input
            type="file"
            id="file-input"
            accept=".wav,.flac,.mp3"
            multiple
          />
          <button
            class="select-button"
            onclick="document.getElementById('file-input').click()"
          >
            Select Files
          </button>
        </div>
        <div class="analyze-part" style="display: none">
          <div class="analyze-container">
            <div class="audio-list" id="audio-list"></div>
          </div>
          <div class="center-container">
            <button class="analyze-btn">Analyze</button>
          </div>
        </div>
        <div class="result-part" style="display: none">
          <div class="result-container">
            <div class="audio-list2" id="audio-list2"></div>
          </div>
          <div class="center-container">
            <button class="again-btn" onclick="location.reload()">
              Upload Again
            </button>
          </div>
        </div>
      </div>
      <div class="loading-container" style="display: none">
        <div class="loading-iconn">
          <img src="../static/images/loading_ico-fixed.png" alt="Loading" />
        </div>
        <button class="cancel-btn" onclick="location.reload()">Cancel</button>
        <div class="progress-bar">
          <div class="bar" id="progress-bar"></div>
        </div>
        <span id="progress-text">Processing Audio Files...</span>
      </div>
    </div>
    <script>
      // Store uploaded files to prevent duplicates
      const uploadedFiles = new Set();

      // Get DOM elements
      const uploadArea = document.getElementById("upload-area");
      const analyzePart = document.querySelector(".analyze-part");
      const audioList = document.getElementById("audio-list");
      const fileInput = document.getElementById("file-input");

      function createAudioElement(file) {
        const audioContainer = document.createElement("div");
        audioContainer.className = "audio-container";

        // Create audio content wrapper
        const audioContent = document.createElement("div");
        audioContent.className = "audio-content";

        // Create audio info section
        const audioInfo = document.createElement("div");
        audioInfo.className = "audio-info";

        // Add file name
        const fileName = document.createElement("div");
        fileName.className = "file-name";
        fileName.textContent = file.name;

        // Add duration
        const duration = document.createElement("div");
        duration.className = "duration";
        duration.textContent = "0:00";

        // Create controls section
        const audioControls = document.createElement("div");
        audioControls.className = "audio-controls";

        // Add play button
        const playBtn = document.createElement("button");
        playBtn.className = "play-btn";
        playBtn.innerHTML = `
      <span class="play-text">Play</span>
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M8 5v14l11-7z"/>
      </svg>
    `;
        // Add delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = `
  <svg class="w-6 h-6 svg-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" viewBox="0 0 24 24">
    <path fill-rule="evenodd" d="M8.586 2.586A2 2 0 0 1 10 2h4a2 2 0 0 1 2 2v2h3a1 1 0 1 1 0 2v12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V8a1 1 0 0 1 0-2h3V4a2 2 0 0 1 .586-1.414ZM10 6h4V4h-4v2Zm1 4a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Zm4 0a1 1 0 1 0-2 0v8a1 1 0 1 0 2 0v-8Z" clip-rule="evenodd"/>
  </svg>
`;

        // Create hidden audio element
        const audio = document.createElement("audio");
        audio.style.display = "none";
        const source = URL.createObjectURL(file);
        audio.src = source;

        // Update duration when metadata is loaded
        audio.addEventListener("loadedmetadata", () => {
          const minutes = Math.floor(audio.duration / 60);
          const seconds = Math.floor(audio.duration % 60);
          duration.textContent = `Duration - ${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;
        });

        // Handle play button click
        playBtn.onclick = () => {
          if (audio.paused) {
            audio.play();
            playBtn.innerHTML = `
  <span class="play-text">Pause</span>
  <svg viewBox="0 0 24 24" width="24" height="24">
    <path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
  </svg>
`;
          } else {
            audio.pause();
            playBtn.innerHTML = `
      <span class="play-text">Play</span>
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M8 5v14l11-7z"/>
      </svg>
    `;
          }
        };

        // Handle delete button click
        deleteBtn.onclick = () => {
          audioContainer.remove();
          URL.revokeObjectURL(source);
          uploadedFiles.delete(file.name);

          // If no more audio files, show upload container again
          if (audioList.children.length === 0) {
            analyzePart.style.display = "none";
            uploadArea.style.display = "block";
          }
        };

        // Assemble the elements
        audioInfo.appendChild(fileName);
        audioInfo.appendChild(duration);
        audioControls.appendChild(playBtn);
        audioControls.appendChild(deleteBtn);
        audioContent.appendChild(audioInfo);
        audioContent.appendChild(audioControls);
        audioContainer.appendChild(audioContent);
        audioContainer.appendChild(audio);

        return audioContainer;
      }

      // Handle file upload
      function handleFiles(files) {
        let hasNewFiles = false;

        for (const file of files) {
          if (!uploadedFiles.has(file.name)) {
            uploadedFiles.add(file.name);
            const audioElement = createAudioElement(file);
            audioList.appendChild(audioElement);
            hasNewFiles = true;
          }
        }

        if (hasNewFiles) {
          uploadArea.style.display = "none";
          analyzePart.style.display = "block";
        }
      }

      // File input change handler
      fileInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
        fileInput.value = ""; // Reset input
      });

      // Drag and drop handlers
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      });

      // Analyze button event listener
      document
        .querySelector(".analyze-btn")
        .addEventListener("click", async () => {
          // Hide analyze part
          document.querySelector(".analyze-part").style.display = "none";

          // Show loading container
          const loadingContainer = document.querySelector(".loading-container");
          loadingContainer.style.display = "block";

          // Hide model toggle when loading starts
          const toggleContainer = document.querySelector(".toggle-container");
          if (toggleContainer) {
            toggleContainer.style.display = "none";
          }

          // Start loading animation
          const progressBar = document.getElementById("progress-bar");
          const progressText = document.getElementById("progress-text");
          let progress = 0;

          // Create EventSource for server-sent events
          const eventSource = new EventSource("/progress");

          // Add debug logging
          console.log("EventSource created");

          // Listen for progress updates
          eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            progress = data.progress;
            const processed = data.processed;
            const total = data.total;

            // Debug logging
            console.log(
              `Progress update received: ${processed}/${total} (${progress}%)`
            );

            // Update progress bar
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Processing Audio Files... ${processed}/${total} (${progress}%)`;

            // If processing is complete, close the connection
            if (progress >= 100) {
              console.log("Processing complete, closing EventSource");
              eventSource.close();
            }
          };

          // Handle any errors
          eventSource.onerror = (error) => {
            console.error("EventSource failed:", error);
            eventSource.close();
          };

          // Handle connection open
          eventSource.onopen = () => {
            console.log("EventSource connection opened");
          };

          try {
            const formData = new FormData();
            // Get audio containers from the correct location
            const audioContainers = document.querySelectorAll(
              "#audio-list .audio-container"
            );

            // Add each file to formData
            for (const container of audioContainers) {
              const audio = container.querySelector("audio");
              const fileName =
                container.querySelector(".file-name").textContent;

              // Get the file from the audio element's src
              const response = await fetch(audio.src);
              const blob = await response.blob();
              formData.append("files[]", blob, fileName);
            }

            // Get current model type
            const modelType =
              document.querySelector(".toggle-text").textContent;
            const headers = {
              "Model-Type":
                modelType.toLowerCase() === "hybrid" ? "proposed" : "baseline",
            };

            // Send to backend
            const response = await fetch("/predict", {
              method: "POST",
              headers: headers,
              body: formData,
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Get the results
            const results = await response.json();

            // Add a small delay before showing results
            await new Promise((resolve) => setTimeout(resolve, 300));

            // Close EventSource if it hasn't been closed already
            if (eventSource.readyState !== 2) {
              // 2 means CLOSED
              eventSource.close();
            }

            // Hide loading container
            loadingContainer.style.display = "none";

            // Show results
            document.querySelector(".result-part").style.display = "block";

            // Clear previous results
            const audioList2 = document.getElementById("audio-list2");
            audioList2.innerHTML = "";

            // Create result elements
            Object.entries(results).forEach(([audioPath, result]) => {
              if (audioPath !== "message") {
                const fileName = audioPath.split("/").pop();
                const resultContainer = document.createElement("div");
                resultContainer.className = "audio-container result-item";

                // Get current theme
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                
                resultContainer.innerHTML = `
                  <div class="audio-content">
                    <div class="audio-info">
                      <div class="file-name">${fileName}</div>
                    </div>
                    <div class="audio-controls">
                      <img 
                        class="prediction-icon" 
                        src="../static/images/${result.prediction.toLowerCase()}-${currentTheme}.png" 
                        alt="${result.prediction}"
                      />
                    </div>
                  </div>
                `;

                audioList2.appendChild(resultContainer);
              }
            });
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while processing the audio files.");
            loadingContainer.style.display = "none";
            document.querySelector(".analyze-part").style.display = "block";
          }
        });

      //SWITCH MODEL PART
      const toggleContainer = document.querySelector(".toggle-container");
      const toggleText = document.querySelector(".toggle-text");

      toggleContainer.addEventListener("click", () => {
        toggleContainer.classList.toggle("active2");
        if (toggleContainer.classList.contains("active2")) {
          toggleText.textContent = "HC";
        } else {
          toggleText.textContent = "Hybrid";
        }
      });

      const settingsButton = document.querySelector(".settings-button");
      const popup = document.querySelector(".popup");
      const darkModeToggle = document.getElementById("darkMode");
      const simpleModeToggle = document.getElementById("simpleMode");

      // Toggle popup
      settingsButton.addEventListener("click", () => {
        popup.classList.toggle("show");
      });

      // Close popup when clicking outside
      document.addEventListener("click", (e) => {
        if (!popup.contains(e.target) && !settingsButton.contains(e.target)) {
          popup.classList.remove("show");
        }
      });

      // Dark mode toggle
      darkModeToggle.addEventListener("change", () => {
        if (darkModeToggle.checked) {
          document.documentElement.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
          // Update prediction icons to dark theme
          document.querySelectorAll('.prediction-icon').forEach(icon => {
            const currentSrc = icon.src;
            icon.src = currentSrc.replace('-light.png', '-dark.png');
          });
          // Update loading icon to dark theme
          document.querySelector('.loading-iconn img').src = '../static/images/loading_ico-fixed-dark.png';
        } else {
          document.documentElement.removeAttribute("data-theme");
          localStorage.setItem("theme", "light");
          // Update prediction icons to light theme
          document.querySelectorAll('.prediction-icon').forEach(icon => {
            const currentSrc = icon.src;
            icon.src = currentSrc.replace('-dark.png', '-light.png');
          });
          // Update loading icon to light theme
          document.querySelector('.loading-iconn img').src = '../static/images/loading_ico-fixed.png';
        }
      });

      // Check for saved theme preference
      window.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          darkModeToggle.checked = true;
          document.documentElement.setAttribute("data-theme", "dark");
          // Update prediction icons to dark theme
          document.querySelectorAll('.prediction-icon').forEach(icon => {
            const currentSrc = icon.src;
            icon.src = currentSrc.replace('-light.png', '-dark.png');
          });
          // Update loading icon to dark theme
          document.querySelector('.loading-iconn img').src = '../static/images/loading_ico-fixed-dark.png';
        }

        // Check if coming back from simple mode
        const isSimpleMode = localStorage.getItem("simpleMode") === "true";
        if (isSimpleMode) {
          simpleModeToggle.checked = true;
        }
      });

      // Simple mode toggle
      simpleModeToggle.addEventListener("change", () => {
        // Store the state in session storage
        sessionStorage.setItem("simpleMode", simpleModeToggle.checked);

        if (!simpleModeToggle.checked) {
          // Reset progress and files before switching back to normal mode
          fetch("/reset", {
            method: "POST",
          })
            .then(() => {
              window.location.href = "/"; // Redirect after reset
            })
            .catch((error) => {
              console.error("Error resetting:", error);
              window.location.href = "/"; // Redirect anyway if reset fails
            });
        }
      });

      // Check stored state when page loads
      document.addEventListener("DOMContentLoaded", () => {
        // Set simple mode toggle to checked in simple.html
        if (simpleModeToggle) {
          simpleModeToggle.checked = true;
          sessionStorage.setItem("simpleMode", "true");
        }
      });

      document.querySelector(".cancel-btn").onclick = async () => {
        try {
          // Send termination request which will reset backend counts
          await fetch("/terminate", {
            method: "POST",
          });

          // Close EventSource connection
          if (eventSource && eventSource.readyState !== 2) {
            eventSource.close();
          }

          // Reset frontend counts
          progress = 0;
          progressBar.style.width = "0%";
          progressText.textContent = "Processing Audio Files...";

          // Reload the page
          location.reload();
        } catch (error) {
          console.error("Error terminating prediction:", error);
          location.reload();
        }
      };

      document.querySelector(".again-btn").onclick = async () => {
        try {
          // Reset backend counts
          await fetch("/reset", {
            // We'll create this endpoint
            method: "POST",
          });

          // Close any existing EventSource
          if (eventSource && eventSource.readyState !== 2) {
            eventSource.close();
          }

          // Reset frontend counts
          progress = 0;
          progressBar.style.width = "0%";
          progressText.textContent = "Processing Audio Files...";

          // Reload the page
          location.reload();
        } catch (error) {
          console.error("Error resetting:", error);
          location.reload();
        }
      };
    </script>
  </body>
</html>
